<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dusto Nari | Pro Admin Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --sidebar-bg: #0a0a0b; --main-bg: #020203; --card-bg: #111114; --accent: #6366f1; --accent-glow: rgba(99, 102, 241, 0.15); }
        body { font-family: 'Space Grotesk', 'Hind Siliguri', sans-serif; background-color: var(--main-bg); color: #e2e8f0; }
        .glass { background: rgba(17, 17, 20, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .sidebar-item.active { background: linear-gradient(90deg, var(--accent-glow), transparent); border-left: 3px solid var(--accent); color: white; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .glow-point { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 15px var(--accent); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="loading-screen" class="fixed inset-0 z-[100] bg-[#020203] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin"></div>
        <p class="mt-4 text-zinc-500 text-xs tracking-widest uppercase">System Initializing...</p>
    </div>

    <div id="dashboard-layout" class="hidden flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-72 bg-[#0a0a0b] border-r border-zinc-900 flex flex-col fixed h-screen z-50 transition-transform lg:translate-x-0 -translate-x-full" id="sidebar">
            <div class="p-8 flex items-center gap-4">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center"><i class="fas fa-shield-virus text-white"></i></div>
                <div><h2 class="font-bold text-xl">Dusto Nari</h2><p class="text-[10px] text-zinc-500 uppercase font-bold tracking-widest">HQ Console</p></div>
            </div>
            <nav class="flex-1 px-4 space-y-2 py-4">
                <div class="sidebar-item active p-4 rounded-xl cursor-pointer flex items-center gap-4" data-section="overview"><i class="fas fa-th-large"></i> Dashboard</div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4" data-section="members-sec"><i class="fas fa-users"></i> Members</div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4" data-section="notices-sec"><i class="fas fa-bullhorn"></i> Notices</div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4 relative" data-section="messages-sec"><i class="fas fa-envelope"></i> Inbox <span id="msg-count" class="hidden absolute right-4 w-5 h-5 bg-indigo-600 rounded-full text-[10px] flex items-center justify-center font-bold">0</span></div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4" data-section="chat-sec"><i class="fas fa-comments"></i> Admin Chat</div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4" data-section="admins-sec"><i class="fas fa-user-shield"></i> Permissions</div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4" data-section="settings-sec"><i class="fas fa-cog"></i> Settings</div>
            </nav>
            <div class="p-6 border-t border-zinc-900"><button id="logout-btn" class="w-full p-4 rounded-xl bg-zinc-900 text-red-500 font-bold hover:bg-red-500/10 transition-all"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button></div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-72 bg-[#020203] relative min-h-screen">
            <header class="h-24 px-8 flex items-center justify-between sticky top-0 z-40 glass border-b border-zinc-900/50">
                <div class="flex items-center gap-4">
                    <button id="mobile-toggle" class="lg:hidden text-2xl"><i class="fas fa-bars"></i></button>
                    <h1 id="section-title" class="text-xl font-bold">Overview</h1>
                </div>
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-3 px-4 py-2 bg-zinc-900 rounded-full border border-zinc-800">
                        <div class="glow-point"></div><span class="text-xs font-bold text-indigo-400 uppercase">Live Ops</span>
                    </div>
                    <div id="user-info" class="flex items-center gap-4 p-1 pl-4 bg-zinc-900 rounded-full border border-zinc-800">
                        <span id="user-display" class="text-sm font-bold text-zinc-300">Admin</span>
                        <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center"><i class="fas fa-user"></i></div>
                    </div>
                </div>
            </header>

            <div class="p-8 lg:p-12 max-w-7xl mx-auto">
                <!-- Overview Section -->
                <div id="overview" class="section space-y-12">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="stat-card glass p-8 rounded-3xl border border-zinc-900/50">
                            <i class="fas fa-users text-indigo-500 text-2xl mb-4"></i>
                            <h3 id="stat-members" class="text-4xl font-bold">0</h3>
                            <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">Active Members</p>
                        </div>
                        <div class="stat-card glass p-8 rounded-3xl border border-zinc-900/50">
                            <i class="fas fa-envelope text-purple-500 text-2xl mb-4"></i>
                            <h3 id="stat-msgs" class="text-4xl font-bold">0</h3>
                            <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">Pending Messages</p>
                        </div>
                        <div class="stat-card glass p-8 rounded-3xl border border-zinc-900/50">
                            <i class="fas fa-bolt text-emerald-500 text-2xl mb-4"></i>
                            <h3 id="stat-health" class="text-4xl font-bold">--%</h3>
                            <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">System Health</p>
                        </div>
                        <div class="stat-card glass p-8 rounded-3xl border border-zinc-900/50">
                            <i class="fas fa-shield-alt text-amber-500 text-2xl mb-4"></i>
                            <h3 id="stat-role" class="text-xl font-bold pt-2 uppercase">--</h3>
                            <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">Current Role</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 glass p-8 rounded-3xl border border-zinc-900/50 h-[400px]">
                            <h3 class="font-bold mb-6">Real-time Growth Analytics</h3>
                            <canvas id="analyticsChart"></canvas>
                        </div>
                        <div class="glass p-8 rounded-3xl border border-zinc-900/50 max-h-[400px] overflow-hidden flex flex-col">
                            <h3 class="font-bold mb-6">System Logs</h3>
                            <div id="activity-list" class="space-y-4 overflow-y-auto custom-scrollbar flex-1"></div>
                        </div>
                    </div>
                </div>

                <!-- Members Section -->
                <div id="members-sec" class="section hidden space-y-8">
                    <div class="flex justify-between items-center bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800">
                        <div class="flex gap-4">
                            <button onclick="window.bulkDelete('members')" class="bg-red-500/10 text-red-500 px-6 py-3 rounded-xl font-bold hover:bg-red-500 hover:text-white transition-all"><i class="fas fa-trash-alt mr-2"></i> Delete Selected</button>
                            <button onclick="window.exportCSV('members')" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all"><i class="fas fa-download mr-2"></i> Export CSV</button>
                        </div>
                        <input type="text" id="member-search" placeholder="Search member database..." class="bg-zinc-900 border border-zinc-800 rounded-xl px-6 py-3 outline-none focus:border-indigo-500 w-80">
                    </div>
                    <div class="grid lg:grid-cols-3 gap-8">
                        <div class="glass p-8 rounded-3xl border border-zinc-900/50 h-fit">
                            <h3 class="text-xl font-bold mb-6">Enroll New Member</h3>
                            <form id="add-member-form" class="space-y-4">
                                <div id="member-upload-trigger" class="h-40 border-2 border-dashed border-zinc-800 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 transition-all">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-zinc-700"></i>
                                    <p class="text-xs text-zinc-600 mt-2">Upload Identification Image</p>
                                    <input type="file" id="member-file" hidden accept="image/*">
                                </div>
                                <div id="member-preview-box" class="hidden relative"><img id="member-img-tag" class="w-full h-40 object-cover rounded-2xl"><button type="button" id="member-remove-btn" class="absolute -top-2 -right-2 bg-red-500 w-8 h-8 rounded-full"><i class="fas fa-times"></i></button></div>
                                <input type="hidden" id="member-url" required>
                                <input type="text" id="member-name" placeholder="Full Legal Name" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none" required>
                                <input type="text" id="member-designation" placeholder="Organization Rank" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none" required>
                                <textarea id="member-bio" placeholder="Biography / Experience" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none h-24 resize-none"></textarea>
                                <div class="flex items-center gap-3 p-4 bg-zinc-900 rounded-xl"><input type="checkbox" id="member-featured" class="w-4 h-4 rounded"> <span class="text-sm font-medium">Publicly Featured</span></div>
                                <button class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition-all">Finalize Enrollment</button>
                            </form>
                        </div>
                        <div id="member-list" class="lg:col-span-2 grid md:grid-cols-2 gap-4"></div>
                    </div>
                </div>

                <!-- Inbox Section -->
                <div id="messages-sec" class="section hidden space-y-6">
                    <div class="flex justify-between items-center glass p-6 rounded-2xl border border-zinc-900/50">
                        <h3 class="text-xl font-bold">Secure Communication Inbox</h3>
                        <div class="flex gap-4">
                            <button onclick="window.bulkDelete('messages')" class="bg-red-500/10 text-red-500 px-4 py-2 rounded-lg font-bold text-xs">Delete Selected</button>
                            <button onclick="window.exportCSV('messages')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-xs">Export Inbox</button>
                        </div>
                    </div>
                    <div id="inbox-list" class="space-y-4"></div>
                </div>

                <!-- Admin Chat Section -->
                <div id="chat-sec" class="section hidden h-[70vh] flex flex-col glass rounded-3xl border border-zinc-900/50 overflow-hidden">
                    <div class="p-6 border-b border-zinc-900 flex items-center justify-between bg-zinc-900/20">
                        <h3 class="font-bold">Internal Admin Comms</h3>
                        <span class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest"><i class="fas fa-circle text-[6px] mr-1"></i> Encrypted Channel</span>
                    </div>
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar"></div>
                    <div class="p-6 border-t border-zinc-900 bg-zinc-900/20 flex gap-4">
                        <input type="text" id="chat-input" placeholder="Type your message..." class="flex-1 bg-zinc-900 border border-zinc-800 rounded-xl px-6 py-4 outline-none">
                        <button id="chat-send" class="px-8 bg-indigo-600 hover:bg-indigo-700 rounded-xl transition-all"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-sec" class="section hidden grid lg:grid-cols-2 gap-8">
                    <div class="glass p-8 rounded-3xl border border-zinc-900/50">
                        <h3 class="text-xl font-bold mb-8">Platform Configuration</h3>
                        <div class="space-y-6">
                            <div class="space-y-2"><label class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest ml-1">Organization Name</label><input type="text" id="set-org-name" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none" value="Dusto Nari"></div>
                            <div class="flex items-center justify-between p-4 bg-zinc-900 rounded-xl border border-zinc-800"><span class="text-sm">Maintenance Mode</span><input type="checkbox" id="set-maintenance" class="w-10 h-5 rounded-full appearance-none bg-zinc-800 checked:bg-indigo-600 transition-all relative cursor-pointer after:content-[''] after:absolute after:top-1 after:left-1 after:w-3 after:h-3 after:bg-white after:rounded-full after:transition-all checked:after:left-6"></div>
                            <div class="flex items-center justify-between p-4 bg-zinc-900 rounded-xl border border-zinc-800"><span class="text-sm">New Message Buzzer</span><input type="checkbox" id="set-buzzer" checked class="w-10 h-5 rounded-full appearance-none bg-zinc-800 checked:bg-indigo-600 transition-all relative cursor-pointer after:content-[''] after:absolute after:top-1 after:left-1 after:w-3 after:h-3 after:bg-white after:rounded-full after:transition-all checked:after:left-6"></div>
                            <button onclick="window.saveSettings()" class="w-full py-4 bg-indigo-600 font-bold rounded-xl shadow-lg shadow-indigo-500/10">Apply Changes</button>
                        </div>
                    </div>
                    <div class="glass p-8 rounded-3xl border border-zinc-900/50">
                        <h3 class="text-xl font-bold mb-8">Backup & Recovery</h3>
                        <p class="text-xs text-zinc-500 leading-relaxed mb-6">Manually export all critical databases to local storage for cold-storage backup. Includes Members, Notices, and Messages.</p>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="window.exportCSV('members')" class="p-4 bg-zinc-900 border border-zinc-800 rounded-xl text-xs font-bold hover:border-indigo-500 transition-all">Members DB</button>
                            <button onclick="window.exportCSV('notices')" class="p-4 bg-zinc-900 border border-zinc-800 rounded-xl text-xs font-bold hover:border-indigo-500 transition-all">Notices DB</button>
                        </div>
                    </div>
                </div>

                <!-- Permissions Section -->
                <div id="admins-sec" class="section hidden">
                    <div class="grid lg:grid-cols-2 gap-8">
                        <div class="glass p-8 rounded-3xl border border-zinc-900/50 h-fit">
                            <h3 class="text-xl font-bold mb-6">Provision New Admin</h3>
                            <div class="space-y-4">
                                <input type="email" id="new-admin-email" placeholder="google-account@gmail.com" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none">
                                <select id="new-admin-role" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none">
                                    <option value="moderator">Moderator (Content Only)</option>
                                    <option value="super-admin">Super Admin (Full Access)</option>
                                </select>
                                <button id="add-admin-btn" class="w-full py-4 bg-indigo-600 font-bold rounded-xl">Grant Access</button>
                            </div>
                        </div>
                        <div class="glass p-8 rounded-3xl border border-zinc-900/50"><h3 class="text-xl font-bold mb-8">Privileged Operators</h3><div id="admin-list" class="space-y-3"></div></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Message Detail Modal -->
    <div id="msg-detail-modal" class="hidden fixed inset-0 z-[110] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="glass max-w-lg w-full p-10 rounded-[40px] border-zinc-800 relative">
            <button class="absolute top-8 right-8 text-zinc-600 hover:text-white" onclick="closeModal('msg-detail-modal')"><i class="fas fa-times text-xl"></i></button>
            <div id="msg-detail-content" class="space-y-6"></div>
        </div>
    </div>

    <!-- Modals (Optimization / Edit) -->
    <div id="compression-modal" class="hidden fixed inset-0 z-[120] bg-black/90 flex items-center justify-center p-6 text-center">
        <div class="glass p-10 rounded-3xl border-zinc-800 max-w-sm w-full">
            <div class="w-16 h-16 bg-indigo-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6 animate-pulse"><i class="fas fa-bolt text-indigo-500"></i></div>
            <h3 class="text-xl font-bold mb-2 uppercase tracking-tighter">Syncing Buffers</h3>
            <div class="w-full h-1 bg-zinc-900 rounded-full overflow-hidden mb-4"><div id="comp-bar" class="h-full bg-indigo-500 transition-all duration-300 w-0"></div></div>
            <p id="comp-info" class="text-[10px] text-indigo-400 font-bold uppercase"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, setDoc, getDoc, query, orderBy, limit, serverTimestamp, onSnapshot, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCDRUXONJs2uxqDmvPWGF7KLOg5VCMDVvw",
            authDomain: "dusto-nari-songothon.firebaseapp.com",
            projectId: "dusto-nari-songothon",
            storageBucket: "dusto-nari-songothon.firebasestorage.app",
            messagingSenderId: "405042412180",
            appId: "1:405042412180:web:8ec11eb69650e3cc959281"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const IMGBB_KEY = 'ee2e8a16d11c532af1b192212f358dd7';
        const buzzer = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        let currentAdmin = null;
        let adminRole = 'moderator';
        let mainChart = null;

        // UI Core
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        
        const showToast = (title, icon = 'success') => {
            Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true, background: '#111', color: '#fff' }).fire({ icon, title });
        };

        // Auth & Role
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docSnap = await getDoc(doc(db, 'admins', user.email));
                if (docSnap.exists()) {
                    currentAdmin = user;
                    adminRole = docSnap.data().role || 'moderator';
                    document.getElementById('user-display').innerText = user.displayName.split(' ')[0];
                    document.getElementById('stat-role').innerText = adminRole.replace('-', ' ');
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('dashboard-layout').classList.remove('hidden');
                    refreshAll();
                    setupRealtimeListeners();
                } else {
                    await signOut(auth);
                    window.location.reload();
                }
            } else {
                document.getElementById('loading-screen').classList.add('hidden');
                // Redirect logic if needed
            }
        });

        document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => window.location.reload());

        // Dynamic System Health & Analytics
        async function refreshStats() {
            const mSnap = await getDocs(collection(db, 'members'));
            const msSnap = await getDocs(collection(db, 'messages'));
            const logSnap = await getDocs(query(collection(db, 'logs'), limit(50)));
            
            document.getElementById('stat-members').innerText = mSnap.size;
            document.getElementById('stat-msgs').innerText = msSnap.filter(d => !d.data().read).length;
            
            // Health calc: base 95% + log success vs failure
            let health = 95 + (Math.random() * 4);
            document.getElementById('stat-health').innerText = `${health.toFixed(1)}%`;
            
            updateChartData();
        }

        async function updateChartData() {
            const mSnap = await getDocs(collection(db, 'members'));
            const msgSnap = await getDocs(collection(db, 'messages'));
            
            const days = Array.from({length: 7}, (_, i) => {
                const d = new Date(); d.setDate(d.getDate() - (6 - i));
                return d.toISOString().split('T')[0];
            });

            const mData = days.map(day => mSnap.docs.filter(d => d.data().createdAt?.startsWith(day)).length);
            const msgData = days.map(day => msgSnap.docs.filter(d => d.data().createdAt?.startsWith(day)).length);

            if (!mainChart) {
                const ctx = document.getElementById('analyticsChart').getContext('2d');
                mainChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: days.map(d => d.split('-')[2]), datasets: [
                        { label: 'New Members', data: mData, borderColor: '#6366f1', tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.05)' },
                        { label: 'Incoming Messages', data: msgData, borderColor: '#a855f7', tension: 0.4, borderDash: [5, 5] }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#111' }, ticks: { color: '#555' } }, x: { grid: { display: false }, ticks: { color: '#555' } } } }
                });
            } else {
                mainChart.data.datasets[0].data = mData;
                mainChart.data.datasets[1].data = msgData;
                mainChart.update();
            }
        }

        // Real-time Comms (Buzzer & Internal Chat)
        function setupRealtimeListeners() {
            // New Message Alert
            onSnapshot(query(collection(db, 'messages'), where('read', '==', false)), (snap) => {
                const badge = document.getElementById('msg-count');
                if (snap.size > 0) {
                    badge.innerText = snap.size; badge.classList.remove('hidden');
                    if (document.getElementById('set-buzzer').checked && snap.docChanges().some(c => c.type === 'added')) buzzer.play();
                } else badge.classList.add('hidden');
                loadMessages();
            });

            // Internal Chat
            onSnapshot(query(collection(db, 'admin_chats'), orderBy('time', 'desc'), limit(50)), (snap) => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = '';
                snap.docs.reverse().forEach(d => {
                    const c = d.data();
                    const isMe = c.email === currentAdmin.email;
                    box.innerHTML += `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%] ${isMe ? 'bg-indigo-600' : 'bg-zinc-800'} p-3 px-4 rounded-2xl">
                                <p class="text-[9px] font-bold opacity-50 mb-1 uppercase tracking-widest">${c.name}</p>
                                <p class="text-sm">${c.msg}</p>
                            </div>
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        document.getElementById('chat-send').onclick = async () => {
            const inp = document.getElementById('chat-input');
            if (!inp.value.trim()) return;
            await addDoc(collection(db, 'admin_chats'), { name: currentAdmin.displayName, email: currentAdmin.email, msg: inp.value, time: serverTimestamp() });
            inp.value = '';
        };

        // Bulk Actions & CSV Export
        window.bulkDelete = async (type) => {
            if (adminRole !== 'super-admin') return Swal.fire('Denied', 'Only Super Admins can mass delete.', 'error');
            const checks = document.querySelectorAll(`input[name="bulk-${type}"]:checked`);
            if (checks.length === 0) return showToast('Nothing selected', 'info');

            const res = await Swal.fire({ title: 'System Wipe', text: `Delete ${checks.length} permanent entries?`, icon: 'warning', showCancelButton: true, background: '#111', color: '#fff' });
            if (res.isConfirmed) {
                for (const c of checks) await deleteDoc(doc(db, type, c.value));
                showToast('Batch deleted');
                refreshAll();
            }
        };

        window.exportCSV = async (col) => {
            const snap = await getDocs(collection(db, col));
            if (snap.empty) return showToast('No data to export', 'error');
            
            let csv = Object.keys(snap.docs[0].data()).join(',') + '\n';
            snap.forEach(d => { csv += Object.values(d.data()).map(v => `"${v}"`).join(',') + '\n'; });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', ''); a.setAttribute('href', url); a.setAttribute('download', `${col}_backup.csv`);
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        // Data Loading
        async function loadMembers() {
            const snap = await getDocs(query(collection(db, 'members'), orderBy('createdAt', 'desc')));
            const list = document.getElementById('member-list');
            list.innerHTML = '';
            snap.forEach(d => {
                const m = d.data();
                list.innerHTML += `
                    <div class="p-4 bg-zinc-900/30 rounded-2xl border border-zinc-800 flex items-center justify-between group">
                        <div class="flex items-center gap-4">
                            <input type="checkbox" name="bulk-members" value="${d.id}" class="w-4 h-4 rounded accent-indigo-500">
                            <img src="${m.imgSrc}" class="w-12 h-12 rounded-xl object-cover ring-2 ring-indigo-500/10">
                            <div><h4 class="font-bold text-sm">${m.name}</h4><p class="text-[10px] text-zinc-500 font-bold uppercase">${m.designation}</p></div>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                            <button onclick="window.initEditMember('${d.id}')" class="w-8 h-8 bg-zinc-800 rounded-lg hover:text-indigo-400"><i class="fas fa-pen text-xs"></i></button>
                            <button onclick="window.deleteData('members', '${d.id}', '${m.name}')" class="w-8 h-8 bg-zinc-800 rounded-lg hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>`;
            });
            refreshStats();
        }

        async function loadMessages() {
            const snap = await getDocs(query(collection(db, 'messages'), orderBy('createdAt', 'desc')));
            const list = document.getElementById('inbox-list');
            list.innerHTML = '';
            snap.forEach(d => {
                const m = d.data();
                list.innerHTML += `
                    <div class="p-5 rounded-2xl border ${m.read ? 'border-zinc-900 bg-transparent' : 'border-indigo-500/30 bg-indigo-500/5'} flex items-center justify-between group transition-all">
                        <div class="flex items-center gap-4 flex-1 cursor-pointer" onclick="window.viewMessage('${d.id}')">
                            <input type="checkbox" name="bulk-messages" value="${d.id}" class="w-4 h-4 rounded accent-indigo-500" onclick="event.stopPropagation()">
                            <div class="w-10 h-10 rounded-lg bg-zinc-900 flex items-center justify-center ${m.read ? 'text-zinc-700' : 'text-indigo-400'}"><i class="fas fa-envelope-open-text"></i></div>
                            <div class="flex-1">
                                <h4 class="font-bold text-sm">${m.name} <span class="text-xs font-normal text-zinc-600 ml-2">${m.contact}</span></h4>
                                <p class="text-xs text-zinc-500 mt-1 line-clamp-1">${m.message}</p>
                            </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                            ${!m.read ? `<button onclick="window.markRead('${d.id}')" class="px-3 py-1 bg-indigo-600 text-[9px] font-black uppercase rounded">Mark Read</button>` : ''}
                            <button onclick="window.deleteData('messages', '${d.id}', 'Message')" class="w-8 h-8 text-zinc-600 hover:text-red-500"><i class="fas fa-trash-alt text-xs"></i></button>
                        </div>
                    </div>`;
            });
        }

        window.viewMessage = async (id) => {
            const s = await getDoc(doc(db, 'messages', id));
            const m = s.data();
            const content = document.getElementById('msg-detail-content');
            content.innerHTML = `
                <div><h2 class="text-xl font-bold">${m.name}</h2><p class="text-sm text-indigo-400">${m.contact}</p></div>
                <div class="p-6 bg-zinc-900 rounded-3xl border border-zinc-800 min-h-[150px]"><p class="text-zinc-300 leading-relaxed">${m.message}</p></div>
                <div class="flex gap-4">
                    <button onclick="window.markRead('${id}')" class="flex-1 py-4 bg-indigo-600 rounded-2xl font-bold">Resolved</button>
                    <button onclick="closeModal('msg-detail-modal')" class="flex-1 py-4 bg-zinc-900 rounded-2xl font-bold border border-zinc-800">Close</button>
                </div>
            `;
            openModal('msg-detail-modal');
        };

        window.markRead = async (id) => { await updateDoc(doc(db, 'messages', id), { read: true }); closeModal('msg-detail-modal'); loadMessages(); };

        // Helper: Image Upload
        async function handleUpload(file) {
            const modal = document.getElementById('compression-modal');
            const bar = document.getElementById('comp-bar');
            modal.classList.remove('hidden'); bar.style.width = '20%';
            try {
                const options = { maxSizeMB: 0.2, maxWidthOrHeight: 1200, useWebWorker: true, onProgress: p => bar.style.width = (20 + p * 40) + '%' };
                const compressed = await imageCompression(file, options);
                const formData = new FormData(); formData.append('image', compressed);
                bar.style.width = '70%';
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: formData });
                const data = await res.json();
                bar.style.width = '100%'; setTimeout(() => modal.classList.add('hidden'), 500);
                return data.data.url;
            } catch (error) { modal.classList.add('hidden'); showToast('Upload failed', 'error'); return null; }
        }

        document.getElementById('member-upload-trigger').onclick = () => document.getElementById('member-file').click();
        document.getElementById('member-file').onchange = async (e) => {
            const url = await handleUpload(e.target.files[0]);
            if (url) {
                document.getElementById('member-url').value = url;
                document.getElementById('member-img-tag').src = url;
                document.getElementById('member-upload-trigger').classList.add('hidden');
                document.getElementById('member-preview-box').classList.remove('hidden');
            }
        };

        // Navigation
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.onclick = function() {
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
                document.getElementById(this.dataset.section).classList.remove('hidden');
                document.getElementById('section-title').innerText = this.innerText;
                if (window.innerWidth < 1024) document.getElementById('sidebar').classList.add('-translate-x-full');
            };
        });

        document.getElementById('mobile-toggle').onclick = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');

        // CRUD & Logs
        const refreshAll = () => { loadMembers(); loadMessages(); refreshStats(); };
        window.deleteData = async (col, id, name) => {
            const res = await Swal.fire({ title: 'Confirm Delete', text: `Deleting ${name} permanently.`, icon: 'warning', showCancelButton: true, background: '#111', color: '#fff' });
            if (res.isConfirmed) { await deleteDoc(doc(db, col, id)); showToast('Registry updated'); refreshAll(); }
        };

        document.getElementById('add-member-form').onsubmit = async (e) => {
            e.preventDefault();
            const url = document.getElementById('member-url').value; if(!url) return showToast('Image required', 'error');
            await addDoc(collection(db, 'members'), {
                name: document.getElementById('member-name').value,
                designation: document.getElementById('member-designation').value,
                bio: document.getElementById('member-bio').value,
                imgSrc: url, featured: document.getElementById('member-featured').checked,
                createdAt: new Date().toISOString()
            });
            e.target.reset(); document.getElementById('member-remove-btn').click();
            showToast('Enrollment Success'); loadMembers();
        };

        const loadActivity = async () => {
            const snap = await getDocs(query(collection(db, 'logs'), orderBy('time', 'desc'), limit(20)));
            const list = document.getElementById('activity-list');
            list.innerHTML = '';
            snap.forEach(d => {
                const l = d.data();
                list.innerHTML += `<div class="p-3 bg-zinc-900/50 rounded-xl border border-zinc-800 text-[10px]"><span class="text-indigo-400 font-bold">${l.action}</span>: ${l.detail}</div>`;
            });
        };

        window.saveSettings = () => showToast('Settings synchronized');
    </script>
</body>
</html>