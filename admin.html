<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dusto Nari | Pro Admin Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --sidebar-bg: #0a0a0b; --main-bg: #020203; --card-bg: #111114; --accent: #6366f1; --accent-glow: rgba(99, 102, 241, 0.15); }
        body { font-family: 'Space Grotesk', 'Hind Siliguri', sans-serif; background-color: var(--main-bg); color: #e2e8f0; }
        .glass { background: rgba(17, 17, 20, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .sidebar-item.active { background: linear-gradient(90deg, var(--accent-glow), transparent); border-left: 3px solid var(--accent); color: white; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .glow-point { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 15px var(--accent); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .section { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="loading-screen" class="fixed inset-0 z-[100] bg-[#020203] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin"></div>
        <p class="mt-4 text-zinc-500 text-xs tracking-widest uppercase">System Initializing...</p>
    </div>

    <div id="dashboard-layout" class="hidden flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-72 bg-[#0a0a0b] border-r border-zinc-900 flex flex-col fixed h-screen z-50 transition-transform lg:translate-x-0 -translate-x-full" id="sidebar">
            <div class="p-8 flex items-center gap-4">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center"><i class="fas fa-shield-virus text-white"></i></div>
                <div><h2 class="font-bold text-xl">Dusto Nari</h2><p class="text-[10px] text-zinc-500 uppercase font-bold tracking-widest">HQ Console</p></div>
            </div>
            <nav class="flex-1 px-4 space-y-2 py-4">
                <div class="sidebar-item active p-4 rounded-xl cursor-pointer flex items-center gap-4" data-section="overview"><i class="fas fa-th-large"></i> Dashboard</div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4" data-section="members-sec"><i class="fas fa-users"></i> Members</div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4" data-section="notices-sec"><i class="fas fa-bullhorn"></i> Notices</div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4 relative" data-section="messages-sec"><i class="fas fa-envelope"></i> Inbox <span id="msg-count" class="hidden absolute right-4 w-5 h-5 bg-indigo-600 rounded-full text-[10px] flex items-center justify-center font-bold">0</span></div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4 relative" data-section="support-sec"><i class="fas fa-headset"></i> Support <span id="support-count" class="hidden absolute right-4 w-5 h-5 bg-emerald-600 rounded-full text-[10px] flex items-center justify-center font-bold">0</span></div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4" data-section="admins-sec"><i class="fas fa-user-shield"></i> Permissions</div>
                <div class="sidebar-item p-4 rounded-xl cursor-pointer flex items-center gap-4" data-section="settings-sec"><i class="fas fa-cog"></i> Settings</div>
            </nav>
            <div class="p-6 border-t border-zinc-900"><button id="logout-btn" class="w-full p-4 rounded-xl bg-zinc-900 text-red-500 font-bold hover:bg-red-500/10 transition-all"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button></div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-72 bg-[#020203] relative min-h-screen">
            <header class="h-24 px-8 flex items-center justify-between sticky top-0 z-40 glass border-b border-zinc-900/50">
                <div class="flex items-center gap-4">
                    <button id="mobile-toggle" class="lg:hidden text-2xl"><i class="fas fa-bars"></i></button>
                    <h1 id="section-title" class="text-xl font-bold">Overview</h1>
                </div>
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-3 px-4 py-2 bg-zinc-900 rounded-full border border-zinc-800">
                        <div class="glow-point"></div><span class="text-xs font-bold text-indigo-400 uppercase">Live Ops</span>
                    </div>
                    <div id="user-info" class="flex items-center gap-4 p-1 pl-4 bg-zinc-900 rounded-full border border-zinc-800">
                        <span id="user-display" class="text-sm font-bold text-zinc-300">Admin</span>
                        <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center"><i class="fas fa-user"></i></div>
                    </div>
                </div>
            </header>

            <div class="p-8 lg:p-12 max-w-7xl mx-auto">
                <!-- Overview Section -->
                <div id="overview" class="section space-y-12">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="stat-card glass p-8 rounded-3xl border border-zinc-900/50">
                            <i class="fas fa-users text-indigo-500 text-2xl mb-4"></i>
                            <h3 id="stat-members" class="text-4xl font-bold">0</h3>
                            <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">Active Members</p>
                        </div>
                        <div class="stat-card glass p-8 rounded-3xl border border-zinc-900/50">
                            <i class="fas fa-envelope text-purple-500 text-2xl mb-4"></i>
                            <h3 id="stat-msgs" class="text-4xl font-bold">0</h3>
                            <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">Pending Messages</p>
                        </div>
                        <div class="stat-card glass p-8 rounded-3xl border border-zinc-900/50">
                            <i class="fas fa-bolt text-emerald-500 text-2xl mb-4"></i>
                            <h3 id="stat-health" class="text-4xl font-bold">--%</h3>
                            <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">System Health</p>
                        </div>
                        <div class="stat-card glass p-8 rounded-3xl border border-zinc-900/50">
                            <i class="fas fa-shield-alt text-amber-500 text-2xl mb-4"></i>
                            <h3 id="stat-role" class="text-xl font-bold pt-2 uppercase">--</h3>
                            <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">Current Role</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 glass p-8 rounded-3xl border border-zinc-900/50 h-[400px]">
                            <h3 class="font-bold mb-6">Real-time Growth Analytics</h3>
                            <canvas id="analyticsChart"></canvas>
                        </div>
                        <div class="glass p-8 rounded-3xl border border-zinc-900/50 max-h-[400px] overflow-hidden flex flex-col">
                            <h3 class="font-bold mb-6">System Logs</h3>
                            <div id="activity-list" class="space-y-4 overflow-y-auto custom-scrollbar flex-1"></div>
                        </div>
                    </div>
                </div>

                <!-- Members Section -->
                <div id="members-sec" class="section hidden space-y-8">
                    <div class="flex justify-between items-center bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800">
                        <div class="flex gap-4">
                            <button onclick="window.bulkDelete('members')" class="bg-red-500/10 text-red-500 px-6 py-3 rounded-xl font-bold hover:bg-red-500 hover:text-white transition-all"><i class="fas fa-trash-alt mr-2"></i> Delete Selected</button>
                            <button onclick="window.exportCSV('members')" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all"><i class="fas fa-download mr-2"></i> Export CSV</button>
                        </div>
                        <input type="text" id="member-search" placeholder="Search member database..." class="bg-zinc-900 border border-zinc-800 rounded-xl px-6 py-3 outline-none focus:border-indigo-500 w-80">
                    </div>
                    <div class="grid lg:grid-cols-3 gap-8">
                        <div class="glass p-8 rounded-3xl border border-zinc-900/50 h-fit">
                            <h3 class="text-xl font-bold mb-6">Enroll New Member</h3>
                            <form id="add-member-form" class="space-y-4">
                                <div id="member-upload-trigger" class="h-40 border-2 border-dashed border-zinc-800 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 transition-all">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-zinc-700"></i>
                                    <p class="text-xs text-zinc-600 mt-2">Upload Identification Image</p>
                                    <input type="file" id="member-file" hidden accept="image/*">
                                </div>
                                <div id="member-preview-box" class="hidden relative"><img id="member-img-tag" class="w-full h-40 object-cover rounded-2xl"><button type="button" id="member-remove-btn" class="absolute -top-2 -right-2 bg-red-500 w-8 h-8 rounded-full"><i class="fas fa-times"></i></button></div>
                                <input type="hidden" id="member-url" required>
                                <input type="text" id="member-name" placeholder="Full Legal Name" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none" required>
                                <input type="text" id="member-designation" placeholder="Organization Rank" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none" required>
                                <textarea id="member-bio" placeholder="Biography / Experience" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none h-24 resize-none"></textarea>
                                <div class="flex items-center gap-3 p-4 bg-zinc-900 rounded-xl"><input type="checkbox" id="member-featured" class="w-4 h-4 rounded"> <span class="text-sm font-medium">Publicly Featured</span></div>
                                <button class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition-all">Finalize Enrollment</button>
                            </form>
                        </div>
                        <div id="member-list" class="lg:col-span-2 grid md:grid-cols-2 gap-4"></div>
                    </div>
                </div>

                <!-- Notices Section -->
                <div id="notices-sec" class="section hidden space-y-8">
                    <div class="flex justify-between items-center bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800">
                        <h3 class="text-xl font-bold">Public Notices</h3>
                        <button onclick="window.bulkDelete('notices')" class="bg-red-500/10 text-red-500 px-6 py-3 rounded-xl font-bold hover:bg-red-500 transition-all"><i class="fas fa-trash-alt mr-2"></i> Delete Selected</button>
                    </div>
                    <div class="grid lg:grid-cols-3 gap-8">
                        <div class="glass p-8 rounded-3xl border border-zinc-900/50 h-fit">
                            <h3 class="text-xl font-bold mb-6">Publish New Notice</h3>
                            <form id="add-notice-form" class="space-y-4">
                                <div id="notice-upload-trigger" class="h-40 border-2 border-dashed border-zinc-800 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 transition-all">
                                    <i class="fas fa-image text-3xl text-zinc-700"></i>
                                    <p class="text-xs text-zinc-600 mt-2">Notice Banner (Optional)</p>
                                    <input type="file" id="notice-file" hidden accept="image/*">
                                </div>
                                <div id="notice-preview-box" class="hidden relative"><img id="notice-img-tag" class="w-full h-40 object-cover rounded-2xl"><button type="button" id="notice-remove-btn" class="absolute -top-2 -right-2 bg-red-500 w-8 h-8 rounded-full"><i class="fas fa-times"></i></button></div>
                                <input type="hidden" id="notice-url">
                                <input type="text" id="notice-title" placeholder="Notice Headline" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none" required>
                                <select id="notice-category" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none" required>
                                    <option value="general">General (সাধারণ)</option>
                                    <option value="urgent">Urgent (জরুরী)</option>
                                    <option value="warning">Warning (সতর্কতা)</option>
                                    <option value="event">Event (ইভেন্ট)</option>
                                </select>
                                <textarea id="notice-content" placeholder="Full Notice Content" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none h-32 resize-none" required></textarea>
                                <button class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition-all">Post Notice</button>
                            </form>
                        </div>
                        <div id="notice-list" class="lg:col-span-2 space-y-4"></div>
                    </div>
                </div>

                <!-- Inbox Section -->
                <div id="messages-sec" class="section hidden space-y-6">
                    <div class="flex justify-between items-center glass p-6 rounded-2xl border border-zinc-900/50">
                        <h3 class="text-xl font-bold">Secure Communication Inbox</h3>
                        <div class="flex gap-4">
                            <button onclick="window.bulkDelete('messages')" class="bg-red-500/10 text-red-500 px-4 py-2 rounded-lg font-bold text-xs">Delete Selected</button>
                            <button onclick="window.exportCSV('messages')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-xs">Export Inbox</button>
                        </div>
                    </div>
                    <div id="inbox-list" class="space-y-4"></div>
                </div>

                <!-- Support Section -->
                <div id="support-sec" class="section hidden h-[75vh] glass rounded-3xl border border-zinc-900/50 overflow-hidden flex">
                    <!-- Sessions List -->
                    <div class="w-80 border-r border-zinc-900 flex flex-col bg-zinc-900/10">
                        <div class="p-6 border-b border-zinc-900 font-bold flex justify-between items-center">
                            <span>Active Chats</span>
                            <span class="text-[10px] bg-indigo-600 px-2 py-0.5 rounded-full" id="active-session-count">0</span>
                        </div>
                        <div id="support-sessions-list" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2">
                            <div class="p-8 text-center text-zinc-600 text-xs">No active sessions</div>
                        </div>
                    </div>
                    
                    <!-- Active Chat Area -->
                    <div id="support-chat-area" class="flex-1 flex flex-col hidden">
                        <div class="p-6 border-b border-zinc-900 flex items-center justify-between bg-zinc-900/20">
                            <div>
                                <h3 id="support-chat-name" class="font-bold">Select a chat</h3>
                                <p id="support-chat-phone" class="text-[10px] text-zinc-500 font-bold uppercase"></p>
                            </div>
                            <button onclick="window.closeSupportChat()" class="text-zinc-500 hover:text-white"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="support-chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar bg-black/20"></div>
                        <div class="p-6 border-t border-zinc-900 bg-zinc-900/20 flex gap-4">
                            <input type="text" id="support-chat-input" placeholder="Reply to user..." class="flex-1 bg-zinc-900 border border-zinc-800 rounded-xl px-6 py-4 outline-none">
                            <button id="support-chat-send" class="px-8 bg-emerald-600 hover:bg-emerald-700 rounded-xl transition-all"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                    
                    <!-- Placeholder -->
                    <div id="support-chat-placeholder" class="flex-1 flex flex-col items-center justify-center text-zinc-700">
                        <i class="fas fa-comments text-5xl mb-4"></i>
                        <p class="font-bold uppercase tracking-widest text-[10px]">Select a session to begin</p>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-sec" class="section hidden grid lg:grid-cols-2 gap-8">
                    <div class="glass p-8 rounded-3xl border border-zinc-900/50">
                        <h3 class="text-xl font-bold mb-8">Platform Configuration</h3>
                        <div class="space-y-6">
                            <div class="space-y-2"><label class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest ml-1">Organization Name</label><input type="text" id="set-org-name" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none" value="Dusto Nari"></div>
                            <div class="flex items-center justify-between p-4 bg-zinc-900 rounded-xl border border-zinc-800"><span class="text-sm">Maintenance Mode</span><input type="checkbox" id="set-maintenance" class="w-10 h-5 rounded-full appearance-none bg-zinc-800 checked:bg-indigo-600 transition-all relative cursor-pointer after:content-[''] after:absolute after:top-1 after:left-1 after:w-3 after:h-3 after:bg-white after:rounded-full after:transition-all checked:after:left-6"></div>
                            <div class="flex items-center justify-between p-4 bg-zinc-900 rounded-xl border border-zinc-800"><span class="text-sm">New Message Buzzer</span><input type="checkbox" id="set-buzzer" checked class="w-10 h-5 rounded-full appearance-none bg-zinc-800 checked:bg-indigo-600 transition-all relative cursor-pointer after:content-[''] after:absolute after:top-1 after:left-1 after:w-3 after:h-3 after:bg-white after:rounded-full after:transition-all checked:after:left-6"></div>
                            <button onclick="window.saveSettings()" class="w-full py-4 bg-indigo-600 font-bold rounded-xl shadow-lg shadow-indigo-500/10">Apply Changes</button>
                        </div>
                    </div>
                    <div class="glass p-8 rounded-3xl border border-zinc-900/50">
                        <h3 class="text-xl font-bold mb-8">Backup & Recovery</h3>
                        <p class="text-xs text-zinc-500 leading-relaxed mb-6">Manually export all critical databases to local storage for cold-storage backup. Includes Members, Notices, and Messages.</p>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="window.exportCSV('members')" class="p-4 bg-zinc-900 border border-zinc-800 rounded-xl text-xs font-bold hover:border-indigo-500 transition-all">Members DB</button>
                            <button onclick="window.exportCSV('notices')" class="p-4 bg-zinc-900 border border-zinc-800 rounded-xl text-xs font-bold hover:border-indigo-500 transition-all">Notices DB</button>
                        </div>
                    </div>
                </div>

                <!-- Permissions Section -->
                <div id="admins-sec" class="section hidden">
                    <div class="grid lg:grid-cols-2 gap-8">
                        <div class="glass p-8 rounded-3xl border border-zinc-900/50 h-fit">
                            <h3 class="text-xl font-bold mb-6">Provision New Admin</h3>
                            <div class="space-y-4">
                                <input type="email" id="new-admin-email" placeholder="google-account@gmail.com" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none">
                                <select id="new-admin-role" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none">
                                    <option value="moderator">Moderator (Content Only)</option>
                                    <option value="super-admin">Super Admin (Full Access)</option>
                                </select>
                                <button id="add-admin-btn" class="w-full py-4 bg-indigo-600 font-bold rounded-xl">Grant Access</button>
                            </div>
                        </div>
                        <div class="glass p-8 rounded-3xl border border-zinc-900/50"><h3 class="text-xl font-bold mb-8">Privileged Operators</h3><div id="admin-list" class="space-y-3"></div></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Message Detail Modal -->
    <div id="msg-detail-modal" class="hidden fixed inset-0 z-[110] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="glass max-w-lg w-full p-10 rounded-[40px] border-zinc-800 relative">
            <button class="absolute top-8 right-8 text-zinc-600 hover:text-white" onclick="closeModal('msg-detail-modal')"><i class="fas fa-times text-xl"></i></button>
            <div id="msg-detail-content" class="space-y-6"></div>
        </div>
    </div>

    <!-- Compression Modal -->
    <div id="compression-modal" class="hidden fixed inset-0 z-[120] bg-black/90 flex items-center justify-center p-6 text-center">
        <div class="glass p-10 rounded-3xl border-zinc-800 max-w-sm w-full">
            <div class="w-16 h-16 bg-indigo-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6 animate-pulse"><i class="fas fa-bolt text-indigo-500"></i></div>
            <h3 class="text-xl font-bold mb-2 uppercase tracking-tighter">Syncing Buffers</h3>
            <div class="w-full h-1 bg-zinc-900 rounded-full overflow-hidden mb-4"><div id="comp-bar" class="h-full bg-indigo-500 transition-all duration-300 w-0"></div></div>
            <p id="comp-info" class="text-[10px] text-indigo-400 font-bold uppercase"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, setDoc, getDoc, query, orderBy, limit, serverTimestamp, onSnapshot, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCDRUXONJs2uxqDmvPWGF7KLOg5VCMDVvw",
            authDomain: "dusto-nari-songothon.firebaseapp.com",
            projectId: "dusto-nari-songothon",
            storageBucket: "dusto-nari-songothon.firebasestorage.app",
            messagingSenderId: "405042412180",
            appId: "1:405042412180:web:8ec11eb69650e3cc959281"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const IMGBB_KEY = 'ee2e8a16d11c532af1b192212f358dd7';
        const buzzer = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        let currentAdmin = null;
        let adminRole = 'moderator';
        let mainChart = null;

        // UI Core
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        
        const showToast = (title, icon = 'success') => {
            Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true, background: '#111', color: '#fff' }).fire({ icon, title });
        };

        let activeSupportSession = null;
        let supportMessagesUnsub = null;

        // Admin Online Status Management
        async function setAdminOnline() {
            if (currentAdmin) {
                try {
                    await setDoc(doc(db, 'system', 'admin_status'), { 
                        status: 'online', 
                        lastActive: serverTimestamp(),
                        email: currentAdmin.email,
                        name: currentAdmin.displayName
                    });
                } catch(e) { console.error("Status update error", e); }
            }
        }

        window.onbeforeunload = () => {
            if (currentAdmin) {
                updateDoc(doc(db, 'system', 'admin_status'), { status: 'offline' });
            }
        };

        // Support System Logic
        function setupSupportListeners() {
            onSnapshot(query(collection(db, 'support_sessions'), orderBy('lastMessageTime', 'desc')), (snap) => {
                const list = document.getElementById('support-sessions-list');
                const badge = document.getElementById('support-count');
                const activeCount = document.getElementById('active-session-count');
                
                list.innerHTML = '';
                let unreadTotal = 0;
                let sessionCount = 0;

                snap.forEach(d => {
                    const s = d.data();
                    sessionCount++;
                    if (!s.adminRead) unreadTotal++;
                    
                    const isSelected = activeSupportSession === d.id;
                    const time = s.lastMessageTime?.toDate ? s.lastMessageTime.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';

                    list.innerHTML += `
                        <div onclick="window.openSupportChat('${d.id}')" class="p-4 rounded-xl cursor-pointer transition-all ${isSelected ? 'bg-indigo-600 text-white' : 'bg-zinc-900/50 hover:bg-zinc-800 border border-zinc-900'} relative">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-bold text-sm truncate pr-4">${s.userName}</h4>
                                <span class="text-[9px] opacity-50">${time}</span>
                            </div>
                            <p class="text-[10px] opacity-70 truncate">${s.lastMessage}</p>
                            ${!s.adminRead ? '<div class="absolute right-4 bottom-4 w-2 h-2 bg-emerald-500 rounded-full glow-point"></div>' : ''}
                        </div>`;
                    
                    if (!s.adminRead && activeSupportSession !== d.id && snap.docChanges().some(c => c.doc.id === d.id && c.type === 'modified')) {
                        if (document.getElementById('set-buzzer').checked) buzzer.play().catch(() => {});
                    }
                });

                activeCount.innerText = sessionCount;
                if (unreadTotal > 0) {
                    badge.innerText = unreadTotal;
                    badge.classList.remove('hidden');
                } else badge.classList.add('hidden');
            }, (err) => console.error("Support listener error", err));
        }

        window.openSupportChat = async (id) => {
            activeSupportSession = id;
            document.getElementById('support-chat-placeholder').classList.add('hidden');
            document.getElementById('support-chat-area').classList.remove('hidden');
            
            const sSnap = await getDoc(doc(db, 'support_sessions', id));
            const s = sSnap.data();
            document.getElementById('support-chat-name').innerText = s.userName;
            document.getElementById('support-chat-phone').innerText = s.userPhone;

            await updateDoc(doc(db, 'support_sessions', id), { adminRead: true });

            if (supportMessagesUnsub) supportMessagesUnsub();
            const q = query(collection(db, `support_sessions/${id}/messages`), orderBy('time', 'asc'));
            supportMessagesUnsub = onSnapshot(q, (snap) => {
                const box = document.getElementById('support-chat-messages');
                box.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.sender === 'admin';
                    const time = m.time?.toDate ? m.time.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
                    
                    box.innerHTML += `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[85%] ${isMe ? 'bg-emerald-600' : 'bg-zinc-800'} p-3 px-4 rounded-2xl relative group">
                                <p class="text-[9px] font-bold opacity-50 mb-1 uppercase tracking-widest">${isMe ? 'Admin' : s.userName}</p>
                                <p class="text-sm">${m.text}</p>
                                <p class="text-[8px] opacity-30 mt-1 text-right">${time}</p>
                            </div>
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.closeSupportChat = () => {
            activeSupportSession = null;
            if (supportMessagesUnsub) supportMessagesUnsub();
            document.getElementById('support-chat-area').classList.add('hidden');
            document.getElementById('support-chat-placeholder').classList.remove('hidden');
        };

        document.getElementById('support-chat-send').onclick = async () => {
            const inp = document.getElementById('support-chat-input');
            const text = inp.value.trim();
            if (!text || !activeSupportSession) return;
            
            inp.value = '';
            try {
                await addDoc(collection(db, `support_sessions/${activeSupportSession}/messages`), {
                    text: text,
                    sender: 'admin',
                    time: serverTimestamp()
                });
                
                await updateDoc(doc(db, 'support_sessions', activeSupportSession), {
                    lastMessage: text,
                    lastMessageTime: serverTimestamp(),
                    userRead: false
                });
            } catch (e) { console.error(e); }
        };

        document.getElementById('support-chat-input').onkeypress = (e) => { if (e.key === 'Enter') document.getElementById('support-chat-send').click(); };

        // Auth & Role
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const docSnap = await getDoc(doc(db, 'admins', user.email));
                    if (docSnap.exists()) {
                        currentAdmin = user;
                        adminRole = docSnap.data().role || 'moderator';
                        document.getElementById('user-display').innerText = user.displayName.split(' ')[0];
                        document.getElementById('stat-role').innerText = adminRole.replace('-', ' ');
                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('dashboard-layout').classList.remove('hidden');
                        
                        await setAdminOnline();
                        refreshAll();
                        setupRealtimeListeners();
                        setupSupportListeners();
                    } else {
                        Swal.fire('Access Denied', 'Your account is not authorized as admin.', 'error').then(() => {
                            signOut(auth).then(() => window.location.reload());
                        });
                    }
                } catch (e) {
                    console.error("Permission check failed", e);
                    document.getElementById('loading-screen').innerHTML = `<div class="text-center"><p class="text-red-500 mb-4">Access Denied: Missing Permissions</p><p class="text-zinc-500 text-xs">Please check your Firebase Firestore rules.</p></div>`;
                }
            } else {
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider).catch(err => console.error("Login error", err));
            }
        });

        document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => window.location.reload());

        // Dynamic System Health & Analytics
        async function refreshStats() {
            try {
                const mSnap = await getDocs(collection(db, 'members'));
                const msSnap = await getDocs(collection(db, 'messages'));
                
                document.getElementById('stat-members').innerText = mSnap.size;
                document.getElementById('stat-msgs').innerText = msSnap.docs.filter(d => !d.data().read).length;
                
                let health = 95 + (Math.random() * 4);
                document.getElementById('stat-health').innerText = `${health.toFixed(1)}%`;
                
                updateChartData();
            } catch (e) { console.error("Stats refresh error", e); }
        }

        async function updateChartData() {
            try {
                const mSnap = await getDocs(collection(db, 'members'));
                const msgSnap = await getDocs(collection(db, 'messages'));
                
                const days = Array.from({length: 7}, (_, i) => {
                    const d = new Date(); d.setDate(d.getDate() - (6 - i));
                    return d.toISOString().split('T')[0];
                });

                const mData = days.map(day => mSnap.docs.filter(d => d.data().createdAt?.startsWith(day)).length);
                const msgData = days.map(day => msgSnap.docs.filter(d => d.data().createdAt?.startsWith(day)).length);

                if (!mainChart) {
                    const ctx = document.getElementById('analyticsChart').getContext('2d');
                    mainChart = new Chart(ctx, {
                        type: 'line',
                        data: { labels: days.map(d => d.split('-')[2]), datasets: [
                            { label: 'New Members', data: mData, borderColor: '#6366f1', tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.05)' },
                            { label: 'Incoming Messages', data: msgData, borderColor: '#a855f7', tension: 0.4, borderDash: [5, 5] }
                        ]},
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#111' }, ticks: { color: '#555' } }, x: { grid: { display: false }, ticks: { color: '#555' } } } }
                    });
                } else {
                    mainChart.data.datasets[0].data = mData;
                    mainChart.data.datasets[1].data = msgData;
                    mainChart.update();
                }
            } catch (e) { console.error("Chart update error", e); }
        }

        // Real-time Listeners
        function setupRealtimeListeners() {
            onSnapshot(query(collection(db, 'messages'), where('read', '==', false)), (snap) => {
                const badge = document.getElementById('msg-count');
                if (snap.size > 0) {
                    badge.innerText = snap.size; badge.classList.remove('hidden');
                    if (document.getElementById('set-buzzer').checked && snap.docChanges().some(c => c.type === 'added')) {
                        buzzer.play().catch(() => {});
                    }
                } else badge.classList.add('hidden');
                loadMessages();
            });
        }

        // Helper: Image Upload
        async function handleUpload(file) {
            const modal = document.getElementById('compression-modal');
            const bar = document.getElementById('comp-bar');
            modal.classList.remove('hidden'); bar.style.width = '20%';
            try {
                const options = { maxSizeMB: 0.2, maxWidthOrHeight: 1200, useWebWorker: true, onProgress: p => bar.style.width = (20 + p * 40) + '%' };
                const compressed = await imageCompression(file, options);
                const formData = new FormData(); formData.append('image', compressed);
                bar.style.width = '70%';
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: formData });
                const data = await res.json();
                bar.style.width = '100%'; setTimeout(() => modal.classList.add('hidden'), 500);
                return data.data.url;
            } catch (error) { modal.classList.add('hidden'); showToast('Upload failed', 'error'); return null; }
        }

        // Member Upload
        document.getElementById('member-upload-trigger').onclick = () => document.getElementById('member-file').click();
        document.getElementById('member-file').onchange = async (e) => {
            const url = await handleUpload(e.target.files[0]);
            if (url) {
                document.getElementById('member-url').value = url;
                document.getElementById('member-img-tag').src = url;
                document.getElementById('member-upload-trigger').classList.add('hidden');
                document.getElementById('member-preview-box').classList.remove('hidden');
            }
        };
        document.getElementById('member-remove-btn').onclick = () => {
            document.getElementById('member-url').value = '';
            document.getElementById('member-preview-box').classList.add('hidden');
            document.getElementById('member-upload-trigger').classList.remove('hidden');
        };

        // Notice Upload
        document.getElementById('notice-upload-trigger').onclick = () => document.getElementById('notice-file').click();
        document.getElementById('notice-file').onchange = async (e) => {
            const url = await handleUpload(e.target.files[0]);
            if (url) {
                document.getElementById('notice-url').value = url;
                document.getElementById('notice-img-tag').src = url;
                document.getElementById('notice-upload-trigger').classList.add('hidden');
                document.getElementById('notice-preview-box').classList.remove('hidden');
            }
        };
        document.getElementById('notice-remove-btn').onclick = () => {
            document.getElementById('notice-url').value = '';
            document.getElementById('notice-preview-box').classList.add('hidden');
            document.getElementById('notice-upload-trigger').classList.remove('hidden');
        };

        // CRUD Actions
        window.deleteData = async (col, id, name) => {
            if (adminRole !== 'super-admin') return showToast('Permission Denied', 'error');
            const res = await Swal.fire({ title: 'Confirm Delete', text: `Deleting ${name} permanently.`, icon: 'warning', showCancelButton: true, background: '#111', color: '#fff' });
            if (res.isConfirmed) { await deleteDoc(doc(db, col, id)); showToast('Entry Deleted'); refreshAll(); }
        };

        document.getElementById('add-member-form').onsubmit = async (e) => {
            e.preventDefault();
            const url = document.getElementById('member-url').value; if(!url) return showToast('Image required', 'error');
            try {
                await addDoc(collection(db, 'members'), {
                    name: document.getElementById('member-name').value,
                    designation: document.getElementById('member-designation').value,
                    bio: document.getElementById('member-bio').value,
                    imgSrc: url, featured: document.getElementById('member-featured').checked,
                    createdAt: new Date().toISOString()
                });
                e.target.reset(); document.getElementById('member-remove-btn').click();
                showToast('Member Enrolled'); loadMembers();
            } catch(e) { showToast('Failed to add member', 'error'); }
        };

        document.getElementById('add-notice-form').onsubmit = async (e) => {
            e.preventDefault();
            try {
                await addDoc(collection(db, 'notices'), {
                    title: document.getElementById('notice-title').value,
                    category: document.getElementById('notice-category').value,
                    content: document.getElementById('notice-content').value,
                    imgSrc: document.getElementById('notice-url').value || null,
                    createdAt: new Date().toISOString()
                });
                e.target.reset(); document.getElementById('notice-remove-btn').click();
                showToast('Notice Published'); loadNotices();
            } catch(e) { showToast('Failed to post notice', 'error'); }
        };

        // Data Loading
        async function loadMembers() {
            try {
                const snap = await getDocs(query(collection(db, 'members'), orderBy('createdAt', 'desc')));
                const list = document.getElementById('member-list');
                list.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    list.innerHTML += `
                        <div class="p-4 bg-zinc-900/30 rounded-2xl border border-zinc-800 flex items-center justify-between group">
                            <div class="flex items-center gap-4">
                                <input type="checkbox" name="bulk-members" value="${d.id}" class="w-4 h-4 rounded accent-indigo-500">
                                <img src="${m.imgSrc}" class="w-12 h-12 rounded-xl object-cover">
                                <div><h4 class="font-bold text-sm">${m.name}</h4><p class="text-[10px] text-zinc-500 font-bold uppercase">${m.designation}</p></div>
                            </div>
                            <button onclick="window.deleteData('members', '${d.id}', '${m.name}')" class="w-8 h-8 text-zinc-700 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i class="fas fa-trash"></i></button>
                        </div>`;
                });
                refreshStats();
            } catch(e) { console.error("Load members error", e); }
        }

        async function loadNotices() {
            try {
                const snap = await getDocs(query(collection(db, 'notices'), orderBy('createdAt', 'desc')));
                const list = document.getElementById('notice-list');
                list.innerHTML = '';
                snap.forEach(d => {
                    const n = d.data();
                    const catColors = { urgent: 'text-red-500 bg-red-500/10', warning: 'text-amber-500 bg-amber-500/10', general: 'text-indigo-500 bg-indigo-500/10', event: 'text-emerald-500 bg-emerald-500/10' };
                    list.innerHTML += `
                        <div class="p-5 bg-zinc-900/50 rounded-2xl border border-zinc-800 flex items-start justify-between group">
                            <div class="flex gap-4 w-full">
                                <input type="checkbox" name="bulk-notices" value="${d.id}" class="mt-1 w-4 h-4 rounded accent-indigo-500">
                                ${n.imgSrc ? `<img src="${n.imgSrc}" class="w-20 h-20 rounded-xl object-cover shrink-0">` : ''}
                                <div class="flex-1">
                                    <div class="flex items-center gap-3">
                                        <h4 class="font-bold text-indigo-400">${n.title}</h4>
                                        <span class="text-[10px] px-2 py-1 rounded-md font-bold uppercase ${catColors[n.category] || catColors.general}">${n.category || 'general'}</span>
                                    </div>
                                    <p class="text-xs text-zinc-500 mt-2 leading-relaxed">${n.content}</p>
                                    <p class="text-[10px] text-zinc-700 mt-2 font-bold uppercase">${new Date(n.createdAt).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <button onclick="window.deleteData('notices', '${d.id}', 'Notice')" class="w-8 h-8 text-zinc-700 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i class="fas fa-trash"></i></button>
                        </div>`;
                });
            } catch(e) { console.error("Load notices error", e); }
        }

        async function loadMessages() {
            try {
                const snap = await getDocs(query(collection(db, 'messages'), orderBy('createdAt', 'desc')));
                const list = document.getElementById('inbox-list');
                list.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    list.innerHTML += `
                        <div class="p-5 rounded-2xl border ${m.read ? 'border-zinc-900 bg-transparent' : 'border-indigo-500/30 bg-indigo-500/5'} flex items-center justify-between group transition-all">
                            <div class="flex items-center gap-4 flex-1 cursor-pointer" onclick="window.viewMessage('${d.id}')">
                                <input type="checkbox" name="bulk-messages" value="${d.id}" class="w-4 h-4 rounded accent-indigo-500" onclick="event.stopPropagation()">
                                <div class="w-10 h-10 rounded-lg bg-zinc-900 flex items-center justify-center ${m.read ? 'text-zinc-700' : 'text-indigo-400'}"><i class="fas fa-envelope-open-text"></i></div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-sm">${m.name} <span class="text-xs font-normal text-zinc-600 ml-2">${m.contact}</span></h4>
                                    <p class="text-xs text-zinc-500 mt-1 line-clamp-1">${m.message}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                ${!m.read ? `<button onclick="window.markRead('${d.id}')" class="px-3 py-1 bg-indigo-600 text-[9px] font-black uppercase rounded">Mark Read</button>` : ''}
                                <button onclick="window.deleteData('messages', '${d.id}', 'Message')" class="w-8 h-8 text-zinc-600 hover:text-red-500"><i class="fas fa-trash-alt text-xs"></i></button>
                            </div>
                        </div>`;
                });
            } catch(e) { console.error("Load messages error", e); }
        }

        window.viewMessage = async (id) => {
            const s = await getDoc(doc(db, 'messages', id));
            const m = s.data();
            const content = document.getElementById('msg-detail-content');
            content.innerHTML = `
                <div><h2 class="text-xl font-bold">${m.name}</h2><p class="text-sm text-indigo-400">${m.contact}</p></div>
                <div class="p-6 bg-zinc-900 rounded-3xl border border-zinc-800 min-h-[150px]"><p class="text-zinc-300 leading-relaxed">${m.message}</p></div>
                <div class="flex gap-4">
                    <button onclick="window.markRead('${id}')" class="flex-1 py-4 bg-indigo-600 rounded-2xl font-bold">Resolved</button>
                    <button onclick="closeModal('msg-detail-modal')" class="flex-1 py-4 bg-zinc-900 rounded-2xl font-bold border border-zinc-800">Close</button>
                </div>
            `;
            openModal('msg-detail-modal');
        };

        window.markRead = async (id) => { await updateDoc(doc(db, 'messages', id), { read: true }); closeModal('msg-detail-modal'); loadMessages(); };

        // Admin Management
        document.getElementById('add-admin-btn').onclick = async () => {
            const email = document.getElementById('new-admin-email').value;
            const role = document.getElementById('new-admin-role').value;
            if(!email) return showToast('Email required', 'error');
            try {
                await setDoc(doc(db, 'admins', email), { role });
                showToast('Admin provisioned');
                loadAdmins();
            } catch(e) { showToast('Permission denied', 'error'); }
        };

        async function loadAdmins() {
            try {
                const snap = await getDocs(collection(db, 'admins'));
                const list = document.getElementById('admin-list');
                list.innerHTML = '';
                snap.forEach(d => {
                    const a = d.data();
                    list.innerHTML += `
                        <div class="p-4 bg-zinc-900 rounded-2xl border border-zinc-800 flex justify-between items-center">
                            <div><p class="text-sm font-bold">${d.id}</p><p class="text-[9px] text-zinc-500 uppercase font-black">${a.role}</p></div>
                            <button onclick="window.deleteData('admins', '${d.id}', 'Admin Access')" class="text-zinc-700 hover:text-red-500"><i class="fas fa-user-minus"></i></button>
                        </div>`;
                });
            } catch(e) { console.error("Load admins error", e); }
        }

        // Navigation
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.onclick = function() {
                const sectionId = this.dataset.section;
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
                document.getElementById(sectionId).classList.remove('hidden');
                document.getElementById('section-title').innerText = this.innerText;
                if (window.innerWidth < 1024) document.getElementById('sidebar').classList.add('-translate-x-full');
            };
        });

        document.getElementById('mobile-toggle').onclick = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');

        const refreshAll = () => { loadMembers(); loadNotices(); loadMessages(); loadAdmins(); refreshStats(); };

        window.bulkDelete = async (type) => {
            if (adminRole !== 'super-admin') return Swal.fire('Denied', 'Only Super Admins can mass delete.', 'error');
            const checks = document.querySelectorAll(`input[name="bulk-${type}"]:checked`);
            if (checks.length === 0) return showToast('Nothing selected', 'info');
            const res = await Swal.fire({ title: 'System Wipe', text: `Delete ${checks.length} entries?`, icon: 'warning', showCancelButton: true, background: '#111', color: '#fff' });
            if (res.isConfirmed) { for (const c of checks) await deleteDoc(doc(db, type, c.value)); showToast('Batch deleted'); refreshAll(); }
        };

        window.exportCSV = async (col) => {
            try {
                const snap = await getDocs(collection(db, col));
                if (snap.empty) return showToast('No data', 'error');
                let csv = Object.keys(snap.docs[0].data()).join(',') + '\n';
                snap.forEach(d => { csv += Object.values(d.data()).map(v => `"${v}"`).join(',') + '\n'; });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `${col}_backup.csv`; a.click();
            } catch(e) { showToast('Export failed', 'error'); }
        };

        refreshStats();
    </script>
</body>
</html>
